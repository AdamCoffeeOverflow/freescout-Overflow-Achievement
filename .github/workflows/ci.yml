name: CI

on:
  pull_request:
  push:
    branches: [ "main" ]

jobs:
  php-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: PHP syntax lint
        run: |
          set -e
          php -v
          while IFS= read -r -d '' file; do
            php -l "$file" >/dev/null
          done < <(find . -path './vendor/*' -prune -o -name '*.php' -print0)

  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITLEAKS_ENABLE_UPLOAD_ARTIFACT: "false"
          GITLEAKS_CONFIG: .gitleaks.toml

  static-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer
      - name: Install tooling
        run: |
          if [ -f composer.json ]; then
            composer install --no-interaction --no-progress
          else
            echo "composer.json not found; skipping"
          fi
      - name: PHPStan
        run: |
          if [ -f vendor/bin/phpstan ]; then
            vendor/bin/phpstan analyse --no-progress
          else
            echo "phpstan not installed; skipping"
          fi
      - name: Psalm
        run: |
          if [ -f vendor/bin/psalm ]; then
            vendor/bin/psalm --no-progress
          else
            echo "psalm not installed; skipping"
          fi
      - name: CS Fixer (dry-run)
        run: |
          if [ -f vendor/bin/php-cs-fixer ]; then
            vendor/bin/php-cs-fixer fix --dry-run --diff --verbose
          else
            echo "php-cs-fixer not installed; skipping"
          fi
      - name: Rector (dry-run)
        run: |
          if [ -f vendor/bin/rector ]; then
            vendor/bin/rector process --dry-run
          else
            echo "rector not installed; skipping"
          fi
